<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4 sm:px-6 lg:px-8">
  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-900 mb-2">MPG Calculator</h1>
      <p class="text-lg text-gray-600">Is it worth upgrading your car for better fuel efficiency?</p>
    </div>

    <!-- Calculator Form -->
    <div class="bg-white rounded-lg shadow-xl p-6 md:p-8">
      <form id="mpg-calculator-form" class="space-y-8">

        <!-- Current Car Section -->
        <div class="border-b border-gray-200 pb-6">
          <h2 class="text-2xl font-semibold text-gray-800 mb-4">Current Car</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="current_mpg" class="block text-sm font-medium text-gray-700 mb-2">
                Current MPG
              </label>
              <input
                type="number"
                id="current_mpg"
                name="current_mpg"
                step="0.1"
                min="0"
                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="e.g., 20"
                required
              >
            </div>

            <div>
              <label for="current_gas_price" class="block text-sm font-medium text-gray-700 mb-2">
                Gas Price ($/gallon)
              </label>
              <input
                type="number"
                id="current_gas_price"
                name="current_gas_price"
                step="0.01"
                min="0"
                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="e.g., 3.50"
                required
              >
            </div>

            <div>
              <label for="current_payment" class="block text-sm font-medium text-gray-700 mb-2">
                Current Car Payment ($/month)
              </label>
              <input
                type="number"
                id="current_payment"
                name="current_payment"
                step="0.01"
                min="0"
                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="e.g., 350"
                required
              >
            </div>

            <div>
              <label for="current_insurance" class="block text-sm font-medium text-gray-700 mb-2">
                Current Insurance ($/month)
              </label>
              <input
                type="number"
                id="current_insurance"
                name="current_insurance"
                step="0.01"
                min="0"
                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="e.g., 150"
                required
              >
            </div>

            <div>
              <label for="current_maintenance" class="block text-sm font-medium text-gray-700 mb-2">
                Current Maintenance & Repair ($/year)
              </label>
              <input
                type="number"
                id="current_maintenance"
                name="current_maintenance"
                step="0.01"
                min="0"
                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="e.g., 2500"
                required
              >
            </div>
          </div>
        </div>

        <!-- New Car Section -->
        <div class="border-b border-gray-200 pb-6">
          <h2 class="text-2xl font-semibold text-gray-800 mb-4">New Car</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="new_mpg" class="block text-sm font-medium text-gray-700 mb-2">
                New Car MPG
              </label>
              <input
                type="number"
                id="new_mpg"
                name="new_mpg"
                step="0.1"
                min="0"
                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="e.g., 50"
                required
              >
            </div>

            <div>
              <label for="new_gas_price" class="block text-sm font-medium text-gray-700 mb-2">
                Gas Price ($/gallon)
                <span class="text-xs text-gray-500">(if different octane required)</span>
              </label>
              <input
                type="number"
                id="new_gas_price"
                name="new_gas_price"
                step="0.01"
                min="0"
                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="e.g., 3.50"
                required
              >
            </div>

            <div>
              <label for="new_payment" class="block text-sm font-medium text-gray-700 mb-2">
                New Car Payment ($/month)
                <span id="new_total_cost_estimate"></span>
              </label>
              <input
                type="number"
                id="new_payment"
                name="new_payment"
                step="0.01"
                min="0"
                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="e.g., 450"
                required
              >
            </div>

            <div>
              <label for="new_insurance" class="block text-sm font-medium text-gray-700 mb-2">
                New Insurance ($/month)
              </label>
              <input
                type="number"
                id="new_insurance"
                name="new_insurance"
                step="0.01"
                min="0"
                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="e.g., 175"
                required
              >
            </div>

            <div>
              <label for="new_maintenance" class="block text-sm font-medium text-gray-700 mb-2">
                New Maintenance & Repair ($/year)
              </label>
              <input
                type="number"
                id="new_maintenance"
                name="new_maintenance"
                step="0.01"
                min="0"
                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="e.g., 900"
                required
              >
            </div>
          </div>
        </div>

        <!-- Driving Habits Section -->
        <div>
          <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your Driving Habits</h2>
          <div>
            <label for="miles_per_month" class="block text-sm font-medium text-gray-700 mb-2">
              Miles Driven Per Month
            </label>
            <input
              type="number"
              id="miles_per_month"
              name="miles_per_month"
              step="1"
              min="0"
              class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              placeholder="e.g., 1000"
              required
            >
          </div>
        </div>

        <!-- Calculate Button -->
        <div class="flex justify-center">
          <button
            type="submit"
            id="calculate-button"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
          >
            Calculate Savings
          </button>
        </div>
      </form>

      <!-- Results Section -->
      <div id="results" class="hidden mt-8 pt-8 border-t border-gray-200">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Results</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Current Car Costs -->
          <div class="bg-red-50 rounded-lg p-6 border border-red-200">
            <h3 class="text-lg font-semibold text-red-800 mb-4">Current Car (Monthly)</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-700">Fuel Cost:</span>
                <span class="font-semibold text-gray-900" id="current_fuel_cost">$0.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-700">Car Payment:</span>
                <span class="font-semibold text-gray-900" id="current_payment_display">$0.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-700">Insurance:</span>
                <span class="font-semibold text-gray-900" id="current_insurance_display">$0.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-700">Maintenance & Repair:</span>
                <span class="font-semibold text-gray-900" id="current_maintenance_display">$0.00</span>
              </div>
              <div class="flex justify-between pt-2 border-t border-red-300">
                <span class="text-gray-900 font-semibold">Total:</span>
                <span class="font-bold text-red-700 text-lg" id="current_total">$0.00</span>
              </div>
            </div>
          </div>

          <!-- New Car Costs -->
          <div class="bg-green-50 rounded-lg p-6 border border-green-200">
            <h3 class="text-lg font-semibold text-green-800 mb-4">New Car (Monthly)</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-700">Fuel Cost:</span>
                <span class="font-semibold text-gray-900" id="new_fuel_cost">$0.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-700">Car Payment:</span>
                <span class="font-semibold text-gray-900" id="new_payment_display">$0.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-700">Insurance:</span>
                <span class="font-semibold text-gray-900" id="new_insurance_display">$0.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-700">Maintenance & Repair:</span>
                <span class="font-semibold text-gray-900" id="new_maintenance_display">$0.00</span>
              </div>
              <div class="flex justify-between pt-2 border-t border-green-300">
                <span class="text-gray-900 font-semibold">Total:</span>
                <span class="font-bold text-green-700 text-lg" id="new_total">$0.00</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Verdict -->
        <div id="verdict" class="mt-6 p-6 rounded-lg text-center">
          <p class="text-2xl font-bold mb-2" id="verdict_text"></p>
          <p class="text-lg" id="verdict_details"></p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Server-injected calculator data
const savedCalculatorData = <%= raw @calculator_data.to_json %>;

document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('mpg-calculator-form');
  const resultsDiv = document.getElementById('results');
  const calculateButton = document.getElementById('calculate-button');

  // Track form state
  let resultsDisplayed = false;
  let lastCalculatedValues = null;

  // Pre-populate form with saved data
  if (savedCalculatorData && Object.keys(savedCalculatorData).length > 0) {
    populateFormFields(savedCalculatorData);

    // Auto-calculate if all fields are populated
    if (form.checkValidity()) {
      calculateCosts();
    }
  }

  // Add input listeners to all form fields to detect changes
  const formInputs = form.querySelectorAll('input[type="number"]');
  formInputs.forEach(input => {
    input.addEventListener('input', function() {
      checkFormState();
    });
  });

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    calculateCosts();

    // Save form data to session after calculation
    const formData = new FormData(form);
    const formObject = Object.fromEntries(formData);
    await saveCalculatorData(formObject);
  });

  function populateFormFields(data) {
    // Populate current car fields
    if (data.current_car) {
      document.getElementById('current_mpg').value = data.current_car.mpg ?? '';
      document.getElementById('current_gas_price').value = data.current_car.gas_price ?? '';
      document.getElementById('current_payment').value = data.current_car.payment ?? '';
      document.getElementById('current_insurance').value = data.current_car.insurance ?? '';
      document.getElementById('current_maintenance').value = data.current_car.maintenance ?? '';
    }

    // Populate new car fields
    if (data.new_car) {
      document.getElementById('new_mpg').value = data.new_car.mpg ?? '';
      document.getElementById('new_gas_price').value = data.new_car.gas_price ?? '';
      document.getElementById('new_payment').value = data.new_car.payment ?? '';
      document.getElementById('new_insurance').value = data.new_car.insurance ?? '';
      document.getElementById('new_maintenance').value = data.new_car.maintenance ?? '';
    }

    // Populate driving habits fields
    if (data.driving_habits) {
      document.getElementById('miles_per_month').value = data.driving_habits.miles_per_month ?? '';
    }
  }

  async function saveCalculatorData(formData) {
    const metaPayload = {
      session: {
        meta: {
          mpg_calculator: {
            current_car: {
              mpg: parseFloat(formData.current_mpg),
              gas_price: parseFloat(formData.current_gas_price),
              payment: parseFloat(formData.current_payment),
              insurance: parseFloat(formData.current_insurance),
              maintenance: parseFloat(formData.current_maintenance)
            },
            new_car: {
              mpg: parseFloat(formData.new_mpg),
              gas_price: parseFloat(formData.new_gas_price),
              payment: parseFloat(formData.new_payment),
              insurance: parseFloat(formData.new_insurance),
              maintenance: parseFloat(formData.new_maintenance)
            },
            driving_habits: {
              miles_per_month: parseInt(formData.miles_per_month)
            },
            last_calculated_at: new Date().toISOString()
          }
        }
      }
    };

    try {
      // Get session ID from index endpoint
      const indexResponse = await fetch('/sessions', {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
      });

      if (!indexResponse.ok) {
        throw new Error(`Failed to get session ID: ${indexResponse.status}`);
      }

      const sessionData = await indexResponse.json();
      const sessionId = sessionData.id;

      // Now update with calculator data using the actual session ID
      const response = await fetch(`/sessions/${sessionId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(metaPayload)
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      console.log('Calculator data saved successfully');
    } catch (error) {
      console.error('Failed to save calculator data:', error);
    }
  }

  /**
    * Calculate the total cost of the car based on the term (in months) and the monthly amount
   * considering the interest rate. The interest should be compounded monthly
   *
   * Uses present value formula: PV = PMT * ((1 - (1 + r)^-n) / r)
   *
   * @param {number} monthly_amount - Monthly payment amount in dollars
   * @param {number} term - Loan term in months (default: 60)
   * @param {number} rate - Annual interest rate as percentage (default: 7.5)
   * @returns {number} Estimated principal/car cost in dollars
   */
  function estimateCarCost(monthly_amount, term=60, rate=7.5) {
    // Convert annual percentage rate to monthly decimal rate
    const monthlyRate = rate / 12 / 100;

    // Handle edge case of 0% interest
    if (monthlyRate === 0) {
      return monthly_amount * term;
    }

    // Calculate present value (principal amount)
    // PV = PMT * ((1 - (1 + r)^-n) / r)
    const presentValue = monthly_amount * ((1 - Math.pow(1 + monthlyRate, -term)) / monthlyRate);

    return presentValue;
  }

  // update cost estimate when monthly payment changes
  const new_payment_input = document.querySelector('#new_payment');

  function updateTotalCostEstimate(value) {
    if (value <= 0) return;

    let total_cost = Math.round(estimateCarCost(value));
    let total_cost_fmt = `$${total_cost.toLocaleString('en-US')}`;

    document.querySelector('#new_total_cost_estimate').innerText = total_cost_fmt;
  }

  updateTotalCostEstimate(new_payment_input.value ?? 0);

  new_payment_input.addEventListener('keyup', function(event) {
    let { value } = event.target;

    updateTotalCostEstimate(value);
  });

  function checkFormState() {
    if (!resultsDisplayed || !lastCalculatedValues) {
      // No results displayed yet, keep button enabled
      enableButton();
      return;
    }

    // Get current form values
    const currentValues = {
      current_mpg: parseFloat(document.getElementById('current_mpg').value) || 0,
      current_gas_price: parseFloat(document.getElementById('current_gas_price').value) || 0,
      current_payment: parseFloat(document.getElementById('current_payment').value) || 0,
      current_insurance: parseFloat(document.getElementById('current_insurance').value) || 0,
      current_maintenance: parseFloat(document.getElementById('current_maintenance').value) || 0,
      new_mpg: parseFloat(document.getElementById('new_mpg').value) || 0,
      new_gas_price: parseFloat(document.getElementById('new_gas_price').value) || 0,
      new_payment: parseFloat(document.getElementById('new_payment').value) || 0,
      new_insurance: parseFloat(document.getElementById('new_insurance').value) || 0,
      new_maintenance: parseFloat(document.getElementById('new_maintenance').value) || 0,
      miles_per_month: parseFloat(document.getElementById('miles_per_month').value) || 0
    };

    // Compare current values with last calculated values
    const valuesMatch = Object.keys(currentValues).every(key => {
      return currentValues[key] === lastCalculatedValues[key];
    });

    // Disable button if values match (results are current), enable if they don't match
    if (valuesMatch) {
      disableButton();
    } else {
      enableButton();
    }
  }

  function disableButton() {
    calculateButton.disabled = true;
    calculateButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'hover:scale-105');
    calculateButton.classList.add('bg-gray-500', 'cursor-not-allowed');
    calculateButton.style.backgroundColor = '#6b7280'; // gray-500
    calculateButton.style.opacity = '0.8';
  }

  function enableButton() {
    calculateButton.disabled = false;
    calculateButton.classList.remove('bg-gray-500', 'cursor-not-allowed');
    calculateButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'hover:scale-105');
    calculateButton.style.backgroundColor = '';
    calculateButton.style.opacity = '';
  }

  function calculateCosts() {
    // Get form values
    const currentMpg = parseFloat(document.getElementById('current_mpg').value);
    const currentGasPrice = parseFloat(document.getElementById('current_gas_price').value);
    const currentPayment = parseFloat(document.getElementById('current_payment').value);
    const currentInsurance = parseFloat(document.getElementById('current_insurance').value);
    const currentMaintenanceAnnual = parseFloat(document.getElementById('current_maintenance').value);

    const newMpg = parseFloat(document.getElementById('new_mpg').value);
    const newGasPrice = parseFloat(document.getElementById('new_gas_price').value);
    const newPayment = parseFloat(document.getElementById('new_payment').value);
    const newInsurance = parseFloat(document.getElementById('new_insurance').value);
    const newMaintenanceAnnual = parseFloat(document.getElementById('new_maintenance').value);

    const milesPerMonth = parseFloat(document.getElementById('miles_per_month').value);

    // Store the calculated values for comparison
    lastCalculatedValues = {
      current_mpg: currentMpg,
      current_gas_price: currentGasPrice,
      current_payment: currentPayment,
      current_insurance: currentInsurance,
      current_maintenance: currentMaintenanceAnnual,
      new_mpg: newMpg,
      new_gas_price: newGasPrice,
      new_payment: newPayment,
      new_insurance: newInsurance,
      new_maintenance: newMaintenanceAnnual,
      miles_per_month: milesPerMonth
    };

    // Calculate fuel costs
    const currentFuelCost = (milesPerMonth / currentMpg) * currentGasPrice;
    const newFuelCost = (milesPerMonth / newMpg) * newGasPrice;

    // Convert annual maintenance to monthly
    const currentMaintenance = currentMaintenanceAnnual / 12;
    const newMaintenance = newMaintenanceAnnual / 12;

    // Calculate totals
    const currentTotal = currentFuelCost + currentPayment + currentInsurance + currentMaintenance;
    const newTotal = newFuelCost + newPayment + newInsurance + newMaintenance;

    // Calculate difference
    const difference = currentTotal - newTotal;

    // Display results
    document.getElementById('current_fuel_cost').textContent = `$${currentFuelCost.toFixed(2)}`;
    document.getElementById('current_payment_display').textContent = `$${currentPayment.toFixed(2)}`;
    document.getElementById('current_insurance_display').textContent = `$${currentInsurance.toFixed(2)}`;
    document.getElementById('current_maintenance_display').textContent = `$${currentMaintenance.toFixed(2)}`;
    document.getElementById('current_total').textContent = `$${currentTotal.toFixed(2)}`;

    document.getElementById('new_fuel_cost').textContent = `$${newFuelCost.toFixed(2)}`;
    document.getElementById('new_payment_display').textContent = `$${newPayment.toFixed(2)}`;
    document.getElementById('new_insurance_display').textContent = `$${newInsurance.toFixed(2)}`;
    document.getElementById('new_maintenance_display').textContent = `$${newMaintenance.toFixed(2)}`;
    document.getElementById('new_total').textContent = `$${newTotal.toFixed(2)}`;

    // Display verdict
    const verdictDiv = document.getElementById('verdict');
    const verdictText = document.getElementById('verdict_text');
    const verdictDetails = document.getElementById('verdict_details');

    if (difference > 0) {
      verdictDiv.className = 'mt-6 p-6 rounded-lg text-center bg-green-100 border-2 border-green-400';
      verdictText.className = 'text-2xl font-bold mb-2 text-green-800';
      verdictText.textContent = `You'll SAVE $${Math.abs(difference).toFixed(2)} per month! ðŸ’°`;
      verdictDetails.className = 'text-lg text-green-700';
      verdictDetails.textContent = `That's $${(Math.abs(difference) * 12).toFixed(2)} per year in savings.`;
    } else if (difference < 0) {
      verdictDiv.className = 'mt-6 p-6 rounded-lg text-center bg-red-100 border-2 border-red-400';
      verdictText.className = 'text-2xl font-bold mb-2 text-red-800';
      verdictText.textContent = `You'll LOSE $${Math.abs(difference).toFixed(2).toLocaleString('en-US')} per month! âš ï¸`;
      verdictDetails.className = 'text-lg text-red-700';
      verdictDetails.textContent = `The new car will cost you $${(Math.abs(difference) * 12).toFixed(2).toLocaleString('en-US')} more per year.`;
    } else {
      verdictDiv.className = 'mt-6 p-6 rounded-lg text-center bg-gray-100 border-2 border-gray-400';
      verdictText.className = 'text-2xl font-bold mb-2 text-gray-800';
      verdictText.textContent = `Break Even`;
      verdictDetails.className = 'text-lg text-gray-700';
      verdictDetails.textContent = `Both cars cost the same per month.`;
    }

    // Show results
    resultsDiv.classList.remove('hidden');
    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    // Mark results as displayed and update button state
    resultsDisplayed = true;
    checkFormState();
  }
});
</script>
